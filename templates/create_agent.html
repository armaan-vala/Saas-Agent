<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Agent - SAS Agent</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ü§ñ Create New Agent</h1>
            <a href="/" class="back-link">‚Üê Back to Home</a>
        </header>

        <div class="main-content">
            <div class="form-container">
                <form id="create-agent-form" class="agent-form">
                    <div class="form-group">
                        <label for="agent-name">Agent Name *</label>
                        <input type="text" id="agent-name" name="name" required 
                               placeholder="e.g. Finance Guru, Research Assistant">
                    </div>

                    <div class="form-group">
                        <label for="agent-description">Description</label>
                        <textarea id="agent-description" name="description" rows="3"
                                  placeholder="Describe what this agent will help with..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="initial-docs">Upload Initial Documents (Optional)</label>
                        <input type="file" id="initial-docs" name="files" multiple 
                               accept=".txt,.pdf,.md" class="file-input">
                        <small class="help-text">Supported formats: TXT, PDF, MD</small>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            ‚ú® Create Agent
                        </button>
                    </div>
                </form>
            </div>

            <div class="preview-section">
                <h3>Agent Preview</h3>
                <div id="agent-preview" class="agent-card preview-card">
                    <div class="agent-info">
                        <h3 id="preview-name">Your Agent Name</h3>
                        <p id="preview-description">Agent description will appear here</p>
                    </div>
                    <div class="agent-actions">
                        <button class="btn btn-primary" disabled>üí¨ Chat</button>
                        <button class="btn btn-secondary" disabled>üìÅ Upload Docs</button>
                    </div>
                </div>
            </div>

            <div id="status-message" class="status-message"></div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // Real-time preview update
        document.getElementById('agent-name').addEventListener('input', updatePreview);
        document.getElementById('agent-description').addEventListener('input', updatePreview);

        function updatePreview() {
            const name = document.getElementById('agent-name').value || 'Your Agent Name';
            const description = document.getElementById('agent-description').value || 'Agent description will appear here';
            
            document.getElementById('preview-name').textContent = name;
            document.getElementById('preview-description').textContent = description;
        }

        // Form submission
        document.getElementById('create-agent-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const agentData = {
                name: formData.get('name'),
                description: formData.get('description')
            };

            try {
                showStatus('Creating agent...', 'info');
                
                // Create agent
                const response = await fetch('/api/create-agent', { // ‚úÖ CHANGED
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(agentData)
                });

                if (response.ok) {
                    const result = await response.json();
                    const agentId = result.agent_id || result.id;
                    
                    showStatus('‚úÖ Agent created successfully!', 'success');
                    
                    // If files were selected, upload them
                    const files = document.getElementById('initial-docs').files;
                    if (files.length > 0) {
                        await uploadInitialDocuments(agentId, files);
                    }
                    
                    // Redirect to chat with the new agent
                    setTimeout(() => {
                        window.location.href = `/chat?agent_id=${agentId}&agent_name=${encodeURIComponent(agentData.name)}`;
                    }, 1500);
                    
                } else {
                    const error = await response.text();
                    showStatus('‚ùå Failed to create agent: ' + error, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Error: ' + error.message, 'error');
            }
        });

        async function uploadInitialDocuments(agentId, files) {
            try {
                showStatus('Uploading initial documents...', 'info');
                
                for (let i = 0; i < files.length; i++) {
                    const formData = new FormData();
                    formData.append('agent_id', agentId);
                    formData.append('file', files[i]);

                    const response = await fetch('/api/upload', { // ‚úÖ CHANGED
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        console.error('Failed to upload:', files[i].name);
                    }
                }
                
                showStatus('‚úÖ Documents uploaded successfully!', 'success');
            } catch (error) {
                console.error('Upload error:', error);
                showStatus('‚ö†Ô∏è Agent created but document upload failed', 'warning');
            }
        }
    </script>
</body>
</html>